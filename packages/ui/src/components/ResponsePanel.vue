<template>
    <div class="loading-overlay" v-if="status === 'loading'">
        <h2 style="font-variant-numeric: tabular-nums; font-weight: 500">Loading...</h2>
        <div class="pad">
            <i class="fas fa-sync fa-spin"></i>
        </div>
        <div class="pad">
            <button class="button" @click="cancelRequest">Cancel Request</button>
        </div>
    </div>
    <template v-if="status !== 'not loaded' && response !== null">
        <div class="response-panel-address-bar">
            <div class="response-panel-address-bar-tag-container">
                <div
                    class="tag" :class="{
                        'green': response.status >= 200 && response.status <= 299,
                        'yellow': response.status >= 400 && response.status <= 499,
                        'red': response.status >= 500 || response.statusText === 'Error'
                    }"
                >
                    <span class="bold">{{ response.status }}</span>
                    {{ response.statusText }}
                </div>
                <div class="tag plr-0 ml-0_6rem" v-if="response.timeTaken">{{ humanFriendlyTime(response.timeTaken) }}</div>
                <div class="tag plr-0 ml-0_6rem" v-if="responseSize">{{ humanFriendlySize(responseSize) }}</div>
            </div>
            <div class="response-panel-address-bar-select-container">
                <select v-model="response" v-if="responses.length > 0" @contextmenu.prevent="handleResponseHistoryContextMenu">
                    <option v-for="response in responses" :value="response">{{ dateFormat(response.createdAt, true) }} | {{ response.name ?? response.url }}</option>
                </select>
            </div>
        </div>
        <div class="response-panel-tabs">
            <div class="response-panel-tab" :class="{ 'response-panel-tab-active': activeResponsePanelTab === responsePanelTab.name }" @click="activeResponsePanelTab = responsePanelTab.name" v-for="responsePanelTab in responsePanelTabs">
                {{ responsePanelTab.label }}
            </div>
            <div class="response-panel-tab-fill"></div>
            <div class="response-panel-tab-actions">
                <i class="fas fa-code" @click="setSelectedTextAsEnvironmentVariable" title="Set selected text as environment variable"></i>
                <i class="fas fa-download" @click="downloadResponse" title="Download response as a file"></i>
                <i class="fas fa-paste" @click="copyResponseToClipboard" title="Copy response to clipboard"></i>
            </div>
        </div>
        <div class="response-panel-tabs-context">
            <template v-if="activeResponsePanelTab === 'Preview'">
                <template v-if="response.statusText !== 'Error'">
                    <div class="content-box" v-if="responseContentType.startsWith('image/svg')">
                        <ImageFromBuffer :buffer="response.buffer" :is-svg="true" style="max-width: 100%; max-height: 100%;" />
                    </div>
                    <div class="content-box" v-else-if="responseContentType.startsWith('image/')">
                        <ImageFromBuffer :buffer="response.buffer" style="max-width: 100%; max-height: 100%;" />
                    </div>
                    <div class="content-box" style="height: 100%" v-else-if="responseContentType.startsWith('text/html')">
                        <IframeFromBuffer :buffer="response.buffer" style="width: 100%; height: 100%; border: none;" />
                    </div>
                    <template v-else>
                        <CodeMirrorResponsePanelPreview :model-value="bufferToJSONString(response.buffer)" @selection-changed="codeMirrorSelectionChanged" />
                    </template>
                </template>
                <div class="content-box" v-else>
                    <div style="white-space: pre-line;">{{ response.error }}</div>
                    <div style="margin-top: 1.5rem; width: 30rem;" v-if="response.error !== 'Error: Invalid URL' && response.error !== 'Error: Request Cancelled' && response.error.startsWith('Error in Plugin ') === false">
                        <div style="margin-bottom: 0.5rem">Possible causes for this error:</div>
                        <div style="margin-left: 0.5rem; margin-bottom: 0.4rem; line-height: 1rem;">1) Given request URL is incorrect or invalid</div>
                        <div style="margin-left: 0.5rem; margin-bottom: 0.4rem; line-height: 1rem;">2) The server for the url isn't returning a valid response for the created request</div>
                        <div style="margin-left: 0.5rem; margin-bottom: 0.4rem; line-height: 1rem;">3) The server for the url has an expired or invalid ssl certificate</div>
                        <template v-if="flags.isBrowser">
                            <template v-if="!flags.hideBrowserRelatedResponsePanelErrors">
                                <div style="margin-left: 0.5rem; margin-bottom: 0.4rem; line-height: 1rem;">4) No CORS headers present for the requested url and requested http method</div>
                                <div style="margin-left: 0.5rem; margin-bottom: 0.4rem; line-height: 1rem;">5) On the browser version, only https urls and localhost can be loaded at the moment. So if you're hitting a http url, the request will fail because https doesn't like requesting http urls.</div>
                            </template>
                            <div v-show="!flags.browserExtensionEnabled" style="margin-top: 1.5rem; line-height: 1rem;">
                                Points 4 & 5 can be bypassed using the <a href="https://chrome.google.com/webstore/detail/restfox-cors-helper/pgoncladmcclnmilkbnmmbldcihdgfnf" target="_blank">Chrome</a> or <a href="https://addons.mozilla.org/en-US/firefox/addon/restfox-cors-helper/" target="_blank">Firefox</a> extension for Restfox
                            </div>
                            <div v-show="flags.browserExtensionEnabled" style="margin-top: 1.5rem; line-height: 1rem;">
                                Browser extension is active. CORS will be bypassed and http requests will also work now.
                            </div>
                        </template>
                    </div>
                    <div style="margin-top: 1.5rem; width: 30rem;" v-if="response.error === 'Error: Invalid URL'">
                        <div style="line-height: 1rem;">Please make sure the protocol (http/https) is present in the URL</div>
                    </div>
                </div>
            </template>
            <template v-if="activeResponsePanelTab === 'Header'">
                <div class="content-box">
                    <table>
                        <tr v-for="header in response.headers">
                            <td style="white-space: nowrap">{{ header[0] }}</td>
                            <td style="word-break: break-word">{{ header[1] }}</td>
                        </tr>
                    </table>
                </div>
            </template>
            <div class="content-box" v-if="activeResponsePanelTab === 'Request'">
                <div><span :class="`request-method--${response.request.method}`" style="padding-right: 0.25rem;">{{ response.request.method }}</span> {{ response.url }}{{ response.request.query }}</div>
                <div style="margin-top: 0.5rem">
                    <table>
                        <tr v-for="header in Object.keys(response.request.headers)">
                            <td style="white-space: nowrap">{{ header }}</td>
                            <td style="word-break: break-word">{{ response.request.headers[header] }}</td>
                        </tr>
                    </table>
                </div>
                <div style="margin-top: 1rem" v-html="responseRequestBodyOutput"></div>
                <div style="margin-top: 1rem">
                    <button class="button" @click="restoreCurrentResponseRequest">Restore</button>
                </div>
            </div>
            <div class="content-box" v-if="activeResponsePanelTab === 'Tests'">
                <div v-if="response.testResults.length === 0">
                    <div style="margin-bottom: 1rem;">No tests found</div>
                    <div>Please refer <a href="https://docs.restfox.dev/plugins/testing-response-data.html" target="_blank">https://docs.restfox.dev/plugins/testing-response-data.html</a> for more info on how to write tests.</div>
                </div>
                <div v-else>
                    <div style="padding-bottom: 0.5rem">Tests: {{ response.testResults.length }}, Passed: {{ passedTestCases }}, Failed: {{ response.testResults.length - passedTestCases }}</div>
                    <div v-for="testResult in response.testResults" style="padding-bottom: 0.5rem">
                        <div :style="{ color: testResult.passed ? 'var(--base-color-success)' : 'var(--base-color-error)' }"><span v-if="testResult.passed">✔  </span><span v-else>✘  </span>{{ testResult.description }}</div>
                        <div v-if="!testResult.passed" style="margin-left: 1rem; margin-top: 0.15rem;">{{ testResult.error }}</div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template v-else>
        <div style="display: grid; place-items: center; height: 100%; grid-row: span 3;">
            <div>Send request to see response here</div>
        </div>
    </template>
    <ContextMenu :options="responseHistoryContextMenuOptions" :element="responseHistoryContextMenuElement" v-model:show="showResponseHistoryContextMenu" @click="handleResponseHistoryContextMenuItemClick" />
</template>

<script>
import { toRaw } from 'vue'
import CodeMirrorResponsePanelPreview from './CodeMirrorResponsePanelPreview.vue'
import ContextMenu from './ContextMenu.vue'
import ImageFromBuffer from './ImageFromBuffer.vue'
import IframeFromBuffer from './IframeFromBuffer.vue'
import {
    dateFormat,
    humanFriendlyTime,
    humanFriendlySize,
    parseContentDispositionHeaderAndGetFileName,
    setEnvironmentVariable,
    getAlertConfirmPromptContainer,
} from '@/helpers'
import { emitter } from '@/event-bus'

export default {
    components: {
        CodeMirrorResponsePanelPreview,
        ContextMenu,
        ImageFromBuffer,
        IframeFromBuffer,
    },
    props: {
        activeTab: Object
    },
    data() {
        return {
            activeResponsePanelTab: 'Preview',
            responseHistoryContextMenuElement: null,
            showResponseHistoryContextMenu: false,
            currentlySelectedText: '',
        }
    },
    computed: {
        responsePanelTabs() {
            let tabs = [
                {
                    name: 'Preview',
                    label: 'Preview'
                },
                {
                    name: 'Header',
                    label: 'Header'
                }
            ]

            if(this.response && 'request' in this.response) {
                tabs.push({
                    name: 'Request',
                    label: 'Request'
                })
            }

            if(this.response && 'testResults' in this.response) {
                const tab = {
                    name: 'Tests',
                    label: 'Tests'
                }

                if(this.response.testResults.length > 0) {
                    tab.label += ` (${this.response.testResults.filter(item => item.passed).length}/${this.response.testResults.length})`
                }

                tabs.push(tab)
            }

            return tabs
        },
        activeWorkspace() {
            return this.$store.state.activeWorkspace
        },
        status() {
            if(this.activeTab && this.activeTab._id in this.$store.state.requestResponseStatus) {
                return this.$store.state.requestResponseStatus[this.activeTab._id]
            }

            return 'not loaded'
        },
        responses() {
            return this.$store.state.responses[this.activeTab._id]
        },
        response: {
            get() {
                if(this.activeTab && this.activeTab._id in this.$store.state.requestResponses) {
                    return this.$store.state.requestResponses[this.activeTab._id]
                }

                return null
            },
            set(response) {
                this.$store.state.requestResponses[this.activeTab._id] = response
            }
        },
        requestAbortController() {
            if(this.activeTab && this.activeTab._id in this.$store.state.requestResponses) {
                return this.$store.state.requestAbortController[this.activeTab._id]
            }

            return null
        },
        responseHistoryContextMenuOptions() {
            if(!this.response) {
                return []
            }

            return [
                {
                    'type': 'option',
                    'label': 'Rename Current Response',
                    'value': 'Rename Current Response',
                    'icon': 'fa fa-edit',
                    'disabled': '_id' in this.response === false
                },
                {
                    'type': 'option',
                    'label': 'Delete Current Response',
                    'value': 'Delete Current Response',
                    'icon': 'fa fa-trash',
                    'disabled': '_id' in this.response === false
                },
                {
                    'type': 'option',
                    'label': 'Clear History',
                    'value': 'Clear History',
                    'icon': 'fa fa-trash'
                }
            ]
        },
        flags() {
            return this.$store.state.flags
        },
        responseSize() {
            if(this.response && 'buffer' in this.response) {
                return this.response.buffer.byteLength
            }

            return null
        },
        responseRequestBodyOutput() {
            if(this.response.request.body === null && !this.response.request.original.body.params) {
                return null
            }

            if(this.response.request.method === 'GET') {
                return null
            }

            if(this.response.request.body instanceof File) {
                // prevent memory leak
                if('responseRequestBodyObjectUrls' in window) {
                    window.responseRequestBodyObjectUrls.forEach(objectUrl => {
                        URL.revokeObjectURL(objectUrl)
                    })
                } else {
                    window.responseRequestBodyObjectUrls = []
                }
                const downloadUrl = URL.createObjectURL(this.response.request.body)
                window.responseRequestBodyObjectUrls.push(downloadUrl)
                return `<div><a href="${downloadUrl}" download="${this.response.request.body.name}">${this.response.request.body.name}</a></div>`
            } else {
                if(this.response.request.original.body.mimeType === 'multipart/form-data' && this.response.request.original.body.params && this.response.request.original.body.params.length > 0) {
                    // prevent memory leak
                    if('responseRequestBodyObjectUrls' in window) {
                        window.responseRequestBodyObjectUrls.forEach(objectUrl => {
                            URL.revokeObjectURL(objectUrl)
                        })
                    } else {
                        window.responseRequestBodyObjectUrls = []
                    }
                    let html = '<table style="border-collapse: collapse; width: 100%;"><tbody>'
                    const tdStyle = 'border: 1px solid var(--default-border-color); padding: 0.5rem;'
                    html += this.response.request.original.body.params.map(param => {
                        const handleFile = item => {
                            const downloadUrl = URL.createObjectURL(item)
                            window.responseRequestBodyObjectUrls.push(downloadUrl)
                            return `<div><a href="${downloadUrl}" download="${item.name}">${item.name}</div>`
                        }
                        return `
                            <tr>
                                <td style="${tdStyle}">${param.name}</td>
                                <td style="${tdStyle}">${param.type === 'text' ? param.value : param.files.map(handleFile)}</td>
                            </tr>
                        `
                    }).join('')
                    html += '</tbody></table>'
                    return html
                }
                return `<div>${this.response.request.body}</div>`
            }
        },
        responseContentType() {
            if(!this.response) {
                return ''
            }

            const contentTypeHeader = this.response.headers.find(header => header[0].toLowerCase() === 'content-type')

            if(contentTypeHeader) {
                return contentTypeHeader[1]
            }

            return ''
        },
        passedTestCases() {
            if(this.response && 'testResults' in this.response) {
                return this.response.testResults.filter(item => item.passed).length
            }

            return 0
        },
    },
    watch: {
        response() {
            if(this.responsePanelTabs.length === 2 && this.activeResponsePanelTab === 'Request') {
                this.activeResponsePanelTab = 'Preview'
            }
        }
    },
    methods: {
        cancelRequest() {
            this.requestAbortController.abort()
        },
        bufferToString(buffer) {
            const textDecoder = new TextDecoder('utf-8')
            return textDecoder.decode(buffer)
        },
        bufferToJSONString(buffer) {
            const responseText = this.bufferToString(buffer)
            try {
                return JSON.stringify(JSON.parse(responseText), null, 4)
            } catch {
                return responseText
            }
        },
        dateFormat,
        humanFriendlyTime,
        humanFriendlySize,
        handleResponseHistoryContextMenu(event) {
            this.responseHistoryContextMenuElement = event.target
            this.showResponseHistoryContextMenu = true
        },
        async handleResponseHistoryContextMenuItemClick(clickedContextMenuitem) {
            if(clickedContextMenuitem === 'Rename Current Response') {
                const newResponseName = await window.createPrompt('Enter new response name', this.response.name)
                if(newResponseName === null) {
                    return
                }
                this.$store.commit('renameCurrentlyActiveResponse', newResponseName)
            }

            if(clickedContextMenuitem === 'Delete Current Response') {
                this.$store.commit('deleteCurrentlyActiveResponse')
            }

            if(clickedContextMenuitem === 'Clear History') {
                this.$store.commit('clearResponseHistory')
            }
        },
        async copyResponseToClipboard() {
            if(!window.isSecureContext) {
                this.$toast.error('Copy to clipboard needs Restfox running under a https url')
                return
            }
            await navigator.clipboard.writeText(this.bufferToJSONString(this.response.buffer))
            this.$toast.success('Copied to clipboard')
        },
        async downloadResponse() {
            const blob = new Blob([this.response.buffer], { type: this.responseContentType })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = this.response.name ?? 'response'
            const contentDispositionHeader = this.response.headers.find(header => header[0].toLowerCase() === 'content-disposition')
            if(contentDispositionHeader && contentDispositionHeader[1]) {
                a.download = parseContentDispositionHeaderAndGetFileName(contentDispositionHeader[1], a.download)
            }
            a.click()
            URL.revokeObjectURL(url)
        },
        async restoreCurrentResponseRequest() {
            const container = getAlertConfirmPromptContainer(this.$el)
            if(!await container.createConfirm('Are you sure? Restoring a request will reset your existing request and make it the same as the saved response\'s request.')) {
                return
            }

            this.activeTab.url = this.response.request.original.url

            const originalRequestBody = this.response.request.original.body

            this.activeTab.body = structuredClone(toRaw(originalRequestBody))

            if(originalRequestBody.mimeType === 'multipart/form-data' && 'params' in originalRequestBody) {
                let params = []
                for(const param of originalRequestBody.params) {
                    let paramExtracted = {...param}
                    if('files' in paramExtracted) {
                        paramExtracted.files = [...paramExtracted.files]
                    }
                    params.push(paramExtracted)
                }
                this.activeTab.body.params = params
            }

            if(originalRequestBody.mimeType === 'application/octet-stream') {
                this.activeTab.body.fileName = this.response.request.body
            }

            if(this.response.request.original.parameters) {
                this.activeTab.parameters = JSON.parse(JSON.stringify(this.response.request.original.parameters))
            }

            if(this.response.request.original.pathParameters) {
                this.activeTab.pathParameters = JSON.parse(JSON.stringify(this.response.request.original.pathParameters))
            }

            if(this.response.request.original.headers) {
                this.activeTab.headers = JSON.parse(JSON.stringify(this.response.request.original.headers))
            }

            if(this.response.request.original.authentication) {
                this.activeTab.authentication = JSON.parse(JSON.stringify(this.response.request.original.authentication))
            }

            emitter.emit('response_panel', 'request restored')
        },
        codeMirrorSelectionChanged(selectedText) {
            this.currentlySelectedText = selectedText
        },
        async setSelectedTextAsEnvironmentVariable() {
            if(this.currentlySelectedText === '') {
                return
            }

            const environment = this.activeWorkspace.environment ?? {}
            const currentlyDefinedEnvironmentVariables = Object.keys(environment)

            const container = getAlertConfirmPromptContainer(this.$el)
            const environmentVariableName = await container.createPrompt('Select / Enter environment variable name', '', currentlyDefinedEnvironmentVariables)

            if(environmentVariableName === null || environmentVariableName === '') {
                return
            }

            setEnvironmentVariable(this.$store, environmentVariableName, this.currentlySelectedText)

            this.$toast.success(`Environment variable set: ${environmentVariableName}`)
        }
    }
}
</script>

<style scoped>
.loading-overlay {
    background-color: var(--response-panel-loader-background-color);
    color: var(--response-panel-loader-color);
    opacity: 1;
    transition: opacity 200ms ease-out;
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    z-index: 9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    text-align: center;
}

.loading-overlay .pad {
    padding: calc(1rem * 1.2);
}

.loading-overlay .fas {
    font-size: 4rem;
}

.response-panel-address-bar {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid var(--default-border-color);
    height: 2rem;
    align-items: center;
    min-width: 0;
    padding-left: 0.5rem;
}

.response-panel-address-bar .response-panel-address-bar-tag-container {
    display: flex;
}

.response-panel-address-bar .tag {
    padding: 0.2rem 0.6rem;
    white-space: nowrap;
    user-select: none;
}

.response-panel-address-bar .tag .bold {
    font-weight: 500;
}

.response-panel-address-bar .tag.green {
    background: #75ba24;
    color: white;
}

.response-panel-address-bar .tag.yellow {
    background: #ec8702;
    color: white;
}

.response-panel-address-bar .tag.red {
    background: #e15251;
    color: white;
}

.response-panel-address-bar .tag.plr-0 {
    padding-left: 0;
    padding-right: 0;
}

.response-panel-address-bar .tag.ml-0_6rem {
    margin-left: 0.6rem;
}

.response-panel-address-bar .response-panel-address-bar-select-container {
    height: 100%;
    margin-left: 1rem;
}

.response-panel-address-bar  .response-panel-address-bar-select-container select {
    width: 100%;
    height: 100%;
    border: 0;
    outline: 0;
    padding-left: 0.5em;
    padding-right: 0.5em;
}

.response-panel-address-bar  .response-panel-address-bar-select-container select:hover {
    background-color: var(--response-panel-history-select-hover-color);
}

.response-panel-tabs {
    display: flex;
    user-select: none;
}

.response-panel-tabs .response-panel-tab {
    padding: 10px 15px;
    border-bottom: 1px solid var(--default-border-color);
    border-left: 1px solid transparent;
    border-right: 1px solid transparent;
    white-space: nowrap;
}

.response-panel-tabs .response-panel-tab-active {
    border-bottom: 1px solid transparent;
    border-right: 1px solid var(--default-border-color);
}

.response-panel-tabs .response-panel-tab-active:not(:first-child) {
    border-left: 1px solid var(--default-border-color);
}

.response-panel-tabs .response-panel-tab-fill {
    width: 100%;
    border-bottom: 1px solid var(--default-border-color);
}

.response-panel-tabs .response-panel-tab-actions {
    display: flex;
    border-bottom: 1px solid var(--default-border-color);
}

.response-panel-tabs .response-panel-tab-actions i {
    height: 100%;
    display: grid;
    place-items: center;
    cursor: pointer;
    font-size: 1rem;
    padding-right: 1rem;
}

.response-panel-tabs-context {
    overflow-y: auto;
}

.response-panel-tabs-context .content-box {
    padding: 1rem;
    word-break: break-all;
}

.response-panel-tabs-context table {
    border-collapse: collapse;
    width: 100%;
}

.response-panel-tabs-context table th, .response-panel-tabs-context table td {
    border: 1px solid var(--default-border-color);
    padding: 0.5rem;
}
</style>
